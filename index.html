<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Weather Widget Google Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS BASE --- */
        body { 
            margin: 0; padding: 0; 
            font-family: 'Roboto', sans-serif; 
            color: #3c4043; /* Couleur texte Google Light */
            background-color: transparent; 
            display: flex; align-items: center; justify-content: center; 
            height: 100vh; overflow: hidden; 
        }

        /* Mode Sombre (Pour le texte uniquement, les icônes sont gérées en JS) */
        @media (prefers-color-scheme: dark) { 
            body { color: #e8eaed; /* Couleur texte Google Dark */ } 
        }

        .widget-container { 
            text-align: center; display: flex; flex-direction: column; 
            align-items: center; gap: 15px; width: 100%; max-width: 320px; 
        }

        /* Bloc Principal */
        .current-weather { display: flex; flex-direction: column; align-items: center; }
        .location { font-size: 0.95rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; font-weight: 500; margin-bottom: 5px; }
        
        .main-row { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .big-temp { font-size: 3.5rem; font-weight: 300; line-height: 1; }
        
        /* Icônes SVG : ON NE MET PLUS DE FILL:CURRENTCOLOR ICI */
        .main-icon svg { width: 68px; height: 68px; /* Un peu plus grand */ }
        .description { font-size: 1rem; opacity: 0.9; margin-top: 4px; font-weight: 400; text-transform: capitalize; }

        /* Prévisions */
        .forecast-list { 
            display: flex; justify-content: space-between; width: 100%; 
            padding-top: 15px; border-top: 1px solid rgba(128, 128, 128, 0.2); 
        }
        .forecast-day { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
        .day-name { font-size: 0.8rem; font-weight: 700; opacity: 0.6; text-transform: uppercase; }
        .day-icon svg { width: 32px; height: 32px; }
        .day-temp { font-size: 0.85rem; opacity: 0.9; font-weight: 500; }

        #loading { font-size: 0.8rem; opacity: 0.6; }
        .error { color: #ff6b6b; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="widget" class="widget-container">
        <div id="loading">Chargement...</div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const params = new URLSearchParams(window.location.search);
        const CITY_NAME = params.get('city') || 'Lyon'; 
        const CACHE_KEY = `weather_v7_color_${CITY_NAME.toLowerCase()}`;
        const CACHE_TTL = 30 * 60 * 1000; 

        // --- 2. GESTION DES COULEURS (GOOGLE STYLE) ---
        // On détecte le mode sombre au chargement pour adapter la palette
        const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        const palette = {
            sun: isDark ? '#fdd835' : '#ffc107', // Jaune soleil
            cloud: isDark ? '#9aa0a6' : '#bdc1c6', // Nuage gris standard
            cloudFront: isDark ? '#b0bec5' : '#eceff1', // Nuage plus clair quand devant le soleil
            rain: '#4285f4', // Bleu Google
            snow: isDark ? '#e8eaed' : '#f1f3f4', // Blanc/Gris très clair
            bolt: '#fbc02d', // Jaune foncé orage
            fog:  isDark ? '#9aa0a6' : '#bdc1c6' // Comme le nuage
        };

        // --- 3. PATHS SVG ORIGINAUX ---
        const P = {
            sun: 'M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000 1.41.996.996 0 001.41 0l1.06-1.06c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06z',
            cloud: 'M19.36 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.64-4.96z',
            rain: 'M12 21c-1.1 0-2-.9-2-2s2-4 2-4 2 3 2 4-.9 2-2 2zm-4 0c-1.1 0-2-.9-2-2s2-4 2-4 2 3 2 4-.9 2-2 2zm8 0c-1.1 0-2-.9-2-2s2-4 2-4 2 3 2 4-.9 2-2 2z',
            snow: 'M12 2L2.5 18h19L12 2zm0 4.2L18.15 16H5.85L12 6.2z',
            bolt: 'M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C7.56 12.5 10.5 7.5 12.5 4L13 11h4c.19 0 .88.54.4.9l-6 9c-.1.15-.24.1-.4.1z',
            fog: 'M4 18h16v2H4zM4 14h16v2H4zM4 10h16v2H4z'
        };

        // --- 4. GÉNÉRATEUR SVG (COULEURS + ALIGNEMENT FIXÉ) ---
        function getSvg(type) {
            let content = '';
            
            // NOTE IMPORTANTE SUR L'ORDRE :
            // Le premier élément ajouté est en arrière-plan. Le dernier est au premier plan.

            if (type === 'sun') {
                content = `<path d="${P.sun}" fill="${palette.sun}"/>`;
            }
            else if (type === 'cloud') {
                content = `<path d="${P.cloud}" fill="${palette.cloud}"/>`;
            }
            else if (type === 'fog') {
                content = `<path d="${P.fog}" fill="${palette.fog}"/>`;
            }
            else if (type === 'cloud-sun') {
                // 1. Soleil (Arrière-plan), décalé en haut à droite
                content += `<path d="${P.sun}" fill="${palette.sun}" transform="translate(6, -6) scale(0.8)"/>`;
                // 2. Nuage (Premier plan), couleur plus claire pour contraste
                content += `<path d="${P.cloud}" fill="${palette.cloudFront}" transform="translate(-2, 2)"/>`;
            } 
            else if (type === 'cloud-rain') {
                // 1. Pluie (Arrière-plan), tombe du bas
                content += `<path d="${P.rain}" fill="${palette.rain}" transform="translate(0, 5)"/>`;
                // 2. Nuage (Premier plan), couleur standard, remonté légèrement
                content += `<path d="${P.cloud}" fill="${palette.cloud}" transform="translate(0, -3)"/>`;
            } 
            else if (type === 'cloud-snow') {
                // 1. Neige
                content += `<path d="${P.snow}" fill="${palette.snow}" transform="translate(0, 7) scale(0.8)"/>`;
                // 2. Nuage
                content += `<path d="${P.cloud}" fill="${palette.cloud}" transform="translate(0, -3)"/>`;
            } 
            else if (type === 'cloud-bolt') {
                // 1. Nuage
                content += `<path d="${P.cloud}" fill="${palette.cloud}" transform="translate(-2, -2)"/>`;
                // 2. Éclair (Premier plan pour bien ressortir)
                content += `<path d="${P.bolt}" fill="${palette.bolt}" transform="translate(2, 2) scale(0.9)"/>`;
            }
            
            // UTILISATION D'UN VIEWBOX PLUS GRAND (-4 à 32) POUR ÉVITER LES COUPURES LORS DES DÉCALAGES
            return `<svg viewBox="-4 -4 32 32">${content}</svg>`;
        }

        // --- 5. MAPPING WMO (Reste identique) ---
        function getWmoData(code) {
            const map = {
                0:  { t: "Ensoleillé", i: 'sun' },
                1:  { t: "Peu nuageux", i: 'cloud-sun' },
                2:  { t: "Éclaircies", i: 'cloud-sun' },
                3:  { t: "Couvert", i: 'cloud' },
                45: { t: "Brouillard", i: 'fog' },
                48: { t: "Brouillard givrant", i: 'fog' },
                51: { t: "Bruine légère", i: 'cloud-rain' },
                53: { t: "Bruine modérée", i: 'cloud-rain' },
                55: { t: "Bruine dense", i: 'cloud-rain' },
                56: { t: "Bruine verglaçante", i: 'cloud-rain' },
                57: { t: "Bruine verglaçante", i: 'cloud-rain' },
                61: { t: "Pluie faible", i: 'cloud-rain' },
                63: { t: "Pluie", i: 'cloud-rain' },
                65: { t: "Forte pluie", i: 'cloud-rain' },
                66: { t: "Pluie verglaçante", i: 'cloud-rain' },
                67: { t: "Pluie verglaçante", i: 'cloud-rain' },
                71: { t: "Chutes de neige", i: 'cloud-snow' },
                73: { t: "Neige modérée", i: 'cloud-snow' },
                75: { t: "Forte neige", i: 'cloud-snow' },
                77: { t: "Grésil", i: 'cloud-snow' },
                80: { t: "Averses", i: 'cloud-rain' },
                81: { t: "Averses modérées", i: 'cloud-rain' },
                82: { t: "Violentes averses", i: 'cloud-rain' },
                85: { t: "Averses de neige", i: 'cloud-snow' },
                86: { t: "Fortes averses neige", i: 'cloud-snow' },
                95: { t: "Orage", i: 'cloud-bolt' },
                96: { t: "Orage et grêle", i: 'cloud-bolt' },
                99: { t: "Fort orage / Grêle", i: 'cloud-bolt' }
            };
            const data = map[code] || { t: "Inconnu", i: 'cloud' };
            return { text: data.t, icon: getSvg(data.i) };
        }

        // --- 6. LOGIQUE APPLICATIVE (Reste identique) ---
        const widgetDiv = document.getElementById('widget');
        
        async function init() {
            const cached = getFromCache();
            if(cached) { render(cached); } else { await fetchData(); }
        }

        function getFromCache() {
            try {
                const raw = localStorage.getItem(CACHE_KEY);
                if (!raw) return null;
                const entry = JSON.parse(raw);
                if (Date.now() - entry.timestamp < CACHE_TTL) return entry.data;
            } catch(e) { console.error(e); }
            return null;
        }

        async function fetchData() {
            try {
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${CITY_NAME}&count=1&language=fr&format=json`);
                const geoData = await geoRes.json();
                if (!geoData.results || !geoData.results.length) throw new Error("Ville introuvable");
                const { latitude, longitude, name } = geoData.results[0];

                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=4`);
                const wData = await wRes.json();

                const finalData = { city: name, current: wData.current_weather, daily: wData.daily };
                localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data: finalData }));
                render(finalData);
            } catch (err) {
                widgetDiv.innerHTML = `<div class="error">Erreur: ${err.message}</div>`;
            }
        }

        function getDayName(dateStr) {
            const d = new Date(dateStr);
            return new Intl.DateTimeFormat('fr-FR', { weekday: 'short' }).format(d).replace('.','');
        }

        function render(data) {
            document.getElementById('loading').style.display = 'none';
            const curCode = data.current.weathercode;
            const curInfo = getWmoData(curCode);

            let forecastHTML = '';
            const d = data.daily;
            for(let i=1; i < 4; i++) {
                if(!d.time[i]) break;
                const dayName = getDayName(d.time[i]);
                const max = Math.round(d.temperature_2m_max[i]);
                const min = Math.round(d.temperature_2m_min[i]);
                const code = d.weathercode[i];
                const info = getWmoData(code);
                forecastHTML += `
                    <div class="forecast-day">
                        <span class="day-name">${dayName}</span>
                        <div class="day-icon">${info.icon}</div>
                        <span class="day-temp">${max}° <span style="opacity:0.6; font-size:0.9em">${min}°</span></span>
                    </div>
                `;
            }

            widgetDiv.innerHTML = `
                <div class="current-weather">
                    <div class="location">${data.city}</div>
                    <div class="main-row">
                        <div class="main-icon">${curInfo.icon}</div>
                        <div class="big-temp">${Math.round(data.current.temperature)}°</div>
                    </div>
                    <div class="description">${curInfo.text}</div>
                </div>
                <div class="forecast-list">${forecastHTML}</div>
            `;
        }
        init();
    </script>
</body>
</html>
