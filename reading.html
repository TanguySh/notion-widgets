<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Cloud Reading</title>
    <style>
        /* --- STYLES IDENTIQUES A LA V2 --- */
        :root { --accent-color: #4285f4; --text-on-accent: white; --bar-bg: rgba(0,0,0,0.06); }
        body { margin: 0; padding: 0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; color: #37352f; background-color: transparent; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        @media (prefers-color-scheme: dark) { body { color: #d4d4d4; } input { color: #d4d4d4 !important; } .book-item { border-bottom-color: rgba(255,255,255,0.06) !important; } :root { --bar-bg: rgba(255,255,255,0.1); } .modal-box { background: #2f3437 !important; border-color: rgba(255,255,255,0.1) !important; } .modal-box p { color: #d4d4d4; } .btn-cancel { color: #d4d4d4 !important; border-color: rgba(255,255,255,0.2) !important; } }
        .container { width: 90%; max-width: 350px; height: auto; display: flex; flex-direction: column; padding-top: 10px; }
        .header-wrapper { position: relative; width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        h1 { font-size: 1.15rem; font-weight: 600; margin: 0; opacity: 1; letter-spacing: -0.02em; width: auto; transition: all 0.3s ease; }
        h1.chip-style { width: 100%; padding: 10px 0 10px 15px; border-radius: 8px; text-align: left; text-transform: uppercase; font-size: 1rem; line-height: 1.5; letter-spacing: 0.5px; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.08); box-sizing: border-box; }
        
        .sync-status { font-size: 0.7rem; color: #9aa0a6; margin-right: 5px; opacity: 0; transition: opacity 0.3s; }
        .sync-status.visible { opacity: 1; }

        ul { list-style: none; padding: 0; margin: 0; flex-grow: 0; height: auto; width: 100%; }
        .book-item { display: flex; flex-direction: column; padding: 12px 0; border-bottom: 1px solid rgba(55, 53, 47, 0.09); animation: fadeIn 0.3s ease; position: relative; }
        .book-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .book-title { font-size: 0.95rem; font-weight: 600; margin-right: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-progress-text { font-size: 0.75rem; color: #9b9a97; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background 0.2s; }
        .book-progress-text:hover { background: rgba(55,53,47,0.08); color: var(--accent-color); }
        .progress-container { width: 100%; height: 6px; background-color: var(--bar-bg); border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--accent-color); border-radius: 3px; width: 0%; transition: width 0.5s ease; }
        .delete-btn { position: absolute; right: 0; top: 10px; opacity: 0; background: none; border: none; cursor: pointer; padding: 0; transition: opacity 0.2s; color: #9b9a97; }
        .delete-btn svg { width: 14px; height: 14px; fill: currentColor; }
        .delete-btn:hover { color: #eb5757; }
        .book-item:hover .delete-btn { opacity: 1; }
        .input-group { margin-top: 10px; position: relative; display: flex; align-items: center; }
        input { width: 100%; background: transparent; border: none; border-bottom: 2px solid rgba(55, 53, 47, 0.16); padding: 8px 0; font-family: inherit; font-size: 0.9rem; outline: none; transition: border-color 0.3s; color: inherit; }
        input::placeholder { color: rgba(55, 53, 47, 0.4); }
        input:focus { border-bottom-color: var(--accent-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.6); backdrop-filter: blur(3px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 80%; max-width: 260px; border: 1px solid rgba(0,0,0,0.1); text-align: center; animation: popIn 0.2s ease; }
        .modal-msg { margin: 0 0 15px 0; font-size: 0.95rem; font-weight: 500; }
        .modal-input { width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.2); border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        .modal-btns { display: flex; justify-content: center; gap: 10px; }
        .modal-btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.85rem; font-weight: 500; font-family: inherit; }
        .btn-cancel { background: transparent; color: #5f6368; border: 1px solid #dadce0; }
        .btn-confirm { background: var(--accent-color); color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="header-wrapper" id="headerWrapper">
            <h1 id="listTitle">Lectures</h1>
            <span id="syncStatus" class="sync-status">Sync...</span>
        </div>
        <ul id="bookList"></ul>
        <div class="input-group">
            <input type="text" id="bookInput" placeholder="Nouveau livre..." autocomplete="off">
        </div>
    </div>
    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <p id="modalMessage" class="modal-msg">Message</p>
            <input type="number" id="modalInput" class="modal-input" style="display:none;">
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="modal-btn btn-confirm" id="modalConfirmBtn">Valider</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ⚠️ CONFIGURATION CLOUD (BIN SPÉCIFIQUE LECTURES)
        // ============================================
        const BIN_ID = "6985f9f7d0ea881f40a5b235"; 
        const API_KEY = "$2a$10$A/bxCPyTSD17CowfTI8XsO.bCVakowlw0adl3XUqkxxcd9Cb6eSua"; 
        // ============================================

        const params = new URLSearchParams(window.location.search);
        const LIST_NAME = params.get('name') || 'reading_default'; 
        const TITLE = params.get('title') || 'Lectures';
        const BG_COLOR = params.get('bg'); 
        const TEXT_COLOR = params.get('color');
        const WIDTH = params.get('width'); 

        const titleEl = document.getElementById('listTitle');
        const headerWrapper = document.getElementById('headerWrapper');
        const container = document.getElementById('mainContainer');
        const syncStatus = document.getElementById('syncStatus');

        if (WIDTH === 'full') { container.style.maxWidth = '100%'; container.style.width = '100%'; } 
        else if (WIDTH) { container.style.maxWidth = WIDTH + 'px'; container.style.width = '100%'; }

        titleEl.textContent = TITLE;
        const googleColors = { 'blue': '#4285f4', 'red': '#ea4335', 'yellow': '#fbbc04', 'green': '#34a853', 'black': '#37352f', 'grey': '#9aa0a6', 'pastel-green': '#dbeddb', 'pastel-red': '#ffeef0', 'pastel-blue': '#e3f2fd', 'pastel-purple': '#f3e5f5' };

        if (BG_COLOR) {
            titleEl.classList.add('chip-style'); headerWrapper.classList.add('has-bg');
            const finalBg = googleColors[BG_COLOR] || BG_COLOR;
            let finalTx = 'white';
            titleEl.style.backgroundColor = finalBg; document.documentElement.style.setProperty('--accent-color', finalBg);
            if (TEXT_COLOR) finalTx = TEXT_COLOR;
            else { const isLight = (BG_COLOR.includes('pastel') || BG_COLOR === 'yellow' || BG_COLOR === '#fbbc04' || BG_COLOR === '#dbeddb'); finalTx = isLight ? '#37352f' : 'white'; }
            titleEl.style.color = finalTx;
        } else { titleEl.style.textAlign = 'left'; }
        if(TITLE === 'none') { titleEl.style.display = 'none'; headerWrapper.style.display = 'none'; }

        // --- DATA ---
        let books = [];
        const input = document.getElementById('bookInput');
        const list = document.getElementById('bookList');
        const modal = document.getElementById('customModal');
        const modalMsg = document.getElementById('modalMessage');
        const modalInput = document.getElementById('modalInput');
        const modalBtn = document.getElementById('modalConfirmBtn');
        let currentCallback = null;
        let saveTimeout;

        // --- CLOUD ---
        async function loadFromCloud() {
            syncStatus.textContent = "Loading..."; syncStatus.classList.add('visible');
            try {
                if(BIN_ID.includes("REMPLACE")) { books = JSON.parse(localStorage.getItem(`notion_reading_${LIST_NAME}`)) || []; render(); syncStatus.classList.remove('visible'); return; }
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
                if(response.ok) { const data = await response.json(); books = data.record.books || []; }
            } catch(e) { console.error(e); }
            render(); syncStatus.classList.remove('visible');
        }

        async function saveToCloud() {
            syncStatus.textContent = "Saving..."; syncStatus.classList.add('visible');
            if(BIN_ID.includes("REMPLACE")) { localStorage.setItem(`notion_reading_${LIST_NAME}`, JSON.stringify(books)); setTimeout(() => syncStatus.classList.remove('visible'), 500); return; }
            try { await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify({ books: books }) }); } catch(e) { console.error(e); }
            setTimeout(() => syncStatus.classList.remove('visible'), 1000);
        }

        function triggerSave() { clearTimeout(saveTimeout); syncStatus.textContent = "Pending..."; syncStatus.classList.add('visible'); saveTimeout = setTimeout(saveToCloud, 1000); }

        function render() {
            list.innerHTML = '';
            books.forEach((book, index) => {
                const li = document.createElement('li'); li.className = 'book-item';
                const percent = Math.min(100, Math.round((book.current / book.total) * 100));
                li.innerHTML = `<div class="book-header"><span class="book-title">${book.title}</span><span class="book-progress-text" onclick="updateProgress(${index})" title="Modifier">${book.current} / ${book.total} (${percent}%)</span></div><div class="progress-container"><div class="progress-bar" style="width: ${percent}%;"></div></div><button class="delete-btn" onclick="deleteBook(${index})"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>`;
                list.appendChild(li);
            });
        }

        function openModal(message, withInput, defaultValue, callback) {
            modalMsg.textContent = message; currentCallback = callback;
            if (withInput) { modalInput.style.display = 'block'; modalInput.value = defaultValue || ''; modalInput.focus(); } 
            else { modalInput.style.display = 'none'; }
            modal.style.display = 'flex';
            if(withInput) setTimeout(() => modalInput.focus(), 50);
        }
        function closeModal() { modal.style.display = 'none'; currentCallback = null; }
        modalBtn.onclick = function() { if (currentCallback) { currentCallback(modalInput.value); } closeModal(); };
        modalInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') modalBtn.click(); });

        function addBook(title) {
            if (!title.trim()) return;
            openModal(`Nombre de pages pour "${title}" ?`, true, "300", (val) => {
                const total = parseInt(val);
                if (!isNaN(total) && total > 0) { books.push({ title: title, total: total, current: 0 }); input.value = ''; render(); triggerSave(); }
            });
        }
        function updateProgress(index) {
            const book = books[index];
            openModal(`Page actuelle pour "${book.title}" ?`, true, book.current, (val) => {
                let newPage = parseInt(val);
                if (!isNaN(newPage)) { if (newPage > book.total) newPage = book.total; if (newPage < 0) newPage = 0; books[index].current = newPage; render(); triggerSave(); }
            });
        }
        function deleteBook(index) { openModal("Supprimer ce livre ?", false, null, () => { books.splice(index, 1); render(); triggerSave(); }); }

        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') addBook(input.value); });
        loadFromCloud();
    </script>
</body>
</html>
